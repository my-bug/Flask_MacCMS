{% extends "admin/base.html" %}

{% block title %}MacCMS10é€šç”¨é‡‡é›† - åå°ç®¡ç†{% endblock %}

{% block content %}
<div class="page-header">
    <h1>MacCMS10é€šç”¨é‡‡é›†</h1>
    <p class="text-muted">å…¼å®¹æ ‡å‡†MacCMS10é‡‡é›†æ¥å£ï¼ˆJSON/XMLæ ¼å¼ï¼‰</p>
</div>

<div class="row">
    <!-- å·¦ä¾§ï¼šé‡‡é›†é…ç½® -->
    <div class="col-md-3">
        <div class="card sticky-config">
            <div class="card-header">
                <h5 class="card-title">é‡‡é›†é…ç½®</h5>
            </div>
            <div class="card-body">
                <form id="collectForm">
                    <div class="form-group form-group-sm mb-2">
                        <label class="small mb-1">é‡‡é›†æ¥å£URL <span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control form-control-sm" name="url" id="collectUrl" 
                                   placeholder="http://api.example.com/api.php/provide/vod/" required>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-sm btn-info" onclick="testUrl()">
                                    <i class="fas fa-vial"></i> æµ‹è¯•
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="loadCategories()">
                                    <i class="fas fa-list"></i> è·å–
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-4">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">æ“ä½œç±»å‹</label>
                                <select class="form-control form-control-sm" name="ac">
                                    <option value="videolist">videolist</option>
                                    <option value="detail">detail</option>
                                    <option value="list">list</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">æ ¼å¼</label>
                                <select class="form-control form-control-sm" name="at">
                                    <option value="json">JSON</option>
                                    <option value="xml">XML</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">åˆ†ç±»ID</label>
                                <input type="text" class="form-control form-control-sm" name="type_id" 
                                       placeholder="å³ä¾§é€‰">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">è§†é¢‘ID</label>
                                <input type="text" class="form-control form-control-sm" name="ids" 
                                       placeholder="123,456">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">å…³é”®è¯</label>
                                <input type="text" class="form-control form-control-sm" name="wd" 
                                       placeholder="æœç´¢">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-3">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">æ—¶é—´(h)</label>
                                <input type="number" class="form-control form-control-sm" name="hours" 
                                       placeholder="24">
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">èµ·å§‹é¡µ</label>
                                <input type="number" class="form-control form-control-sm" name="start_page" 
                                       value="1" min="1" required>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">ç»“æŸé¡µ</label>
                                <input type="number" class="form-control form-control-sm" name="end_page" 
                                       placeholder="å…¨éƒ¨">
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group form-group-sm mb-2">
                                <label class="small mb-1">çº¿ç¨‹</label>
                                <input type="number" class="form-control form-control-sm" name="max_workers" 
                                       value="3" min="1" max="10" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group form-group-sm mb-2">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" 
                                   id="updateExisting" name="update_existing" checked>
                            <label class="custom-control-label small" for="updateExisting">
                                æ›´æ–°å·²å­˜åœ¨çš„è§†é¢‘
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm btn-block">
                        <i class="fas fa-play"></i> å¼€å§‹é‡‡é›†
                    </button>
                </form>
            </div>
        </div>
        
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">ä½¿ç”¨è¯´æ˜</h6>
            </div>
            <div class="card-body small">
                <p class="mb-2"><strong>æ“ä½œæµç¨‹ï¼š</strong></p>
                <ol class="pl-3 mb-2">
                    <li>è¾“å…¥é‡‡é›†æ¥å£URL</li>
                    <li>ç‚¹å‡»"è·å–"æŒ‰é’®</li>
                    <li>åœ¨å³ä¾§é¢„è§ˆåŒºé€‰æ‹©åˆ†ç±»</li>
                    <li>è®¾ç½®é‡‡é›†å‚æ•°</li>
                    <li>å¼€å§‹é‡‡é›†</li>
                </ol>
                <p class="mb-2"><strong>é‡‡é›†ç­–ç•¥ï¼š</strong></p>
                <ul class="pl-3 mb-0">
                    <li>å¤šçº¿ç¨‹å¹¶å‘é‡‡é›†</li>
                    <li>è¿ç»­20ä¸ªé‡å¤è‡ªåŠ¨åœæ­¢</li>
                    <li>æ”¯æŒæ‰‹åŠ¨åœæ­¢</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ä¸­é—´ï¼šé¢„è§ˆåŒºåŸŸ -->
    <div class="col-md-6">
        <!-- åˆ†ç±»é¢„è§ˆ -->
        <div class="card mb-3" id="categoryPreview" style="display:none;">
            <div class="card-header">
                <h5 class="card-title">åˆ†ç±»é¢„è§ˆ <small class="text-muted">(ç‚¹å‡»åˆ†ç±»å¡ç‰‡é€‰æ‹©é‡‡é›†)</small></h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="categoryCards" class="category-preview-grid">
                    <!-- åŠ¨æ€åŠ è½½åˆ†ç±»å¡ç‰‡ -->
                </div>
            </div>
        </div>

        <!-- è§†é¢‘é¢„è§ˆ -->
        <div class="card" id="videoPreview" style="display:none;">
            <div class="card-header">
                <h5 class="card-title">è§†é¢‘é¢„è§ˆ <small class="text-muted">(é»˜è®¤è¿”å›çš„è§†é¢‘åˆ—è¡¨)</small></h5>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <div id="videoCards" class="video-preview-grid">
                    <!-- åŠ¨æ€åŠ è½½è§†é¢‘å¡ç‰‡ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šé‡‡é›†çŠ¶æ€ -->
    <div class="col-md-3">
        <div class="card sticky-tasks">
            <div class="card-header">
                <h5 class="card-title mb-0">é‡‡é›†ä»»åŠ¡</h5>
            </div>
            <div class="card-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <button type="button" class="btn btn-sm btn-warning btn-block mb-3" onclick="cleanupTasks()">
                    <i class="fas fa-broom"></i> æ¸…ç†å·²å®Œæˆ
                </button>
                <div id="taskList">
                    {% if all_status %}
                        {% for task_id, status in all_status.items() %}
                        <div class="task-item mb-2 p-2 border rounded" data-task-id="{{ task_id }}">
                            <div class="mb-2">
                                <strong class="d-block">ä»»åŠ¡ #{{ task_id }}</strong>
                                {% if status.is_running %}
                                <span class="badge badge-primary badge-sm">è¿è¡Œä¸­</span>
                                <button class="btn btn-xs btn-danger mt-1" onclick="stopTask({{ task_id }})">
                                    <i class="fas fa-stop"></i> åœæ­¢
                                </button>
                                {% else %}
                                <span class="badge badge-secondary badge-sm">å·²å®Œæˆ</span>
                                {% endif %}
                            </div>
                            <div class="progress mb-1" style="height: 15px;">
                                <div class="progress-bar bg-success" style="width: {{ (status.success_count / (status.success_count + status.skip_count + status.failed_count) * 100) if (status.success_count + status.skip_count + status.failed_count) > 0 else 0 }}%">
                                    {{ status.success_count }}
                                </div>
                                <div class="progress-bar bg-warning" style="width: {{ (status.skip_count / (status.success_count + status.skip_count + status.failed_count) * 100) if (status.success_count + status.skip_count + status.failed_count) > 0 else 0 }}%">
                                    {{ status.skip_count }}
                                </div>
                                <div class="progress-bar bg-danger" style="width: {{ (status.failed_count / (status.success_count + status.skip_count + status.failed_count) * 100) if (status.success_count + status.skip_count + status.failed_count) > 0 else 0 }}%">
                                    {{ status.failed_count }}
                                </div>
                            </div>
                            <small class="text-muted d-block">é‡å¤: {{ status.consecutive_duplicates }}/20</small>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p class="small">æš‚æ— ä»»åŠ¡</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* æ¸…é™¤æµ®åŠ¨å’Œå¸ƒå±€ä¿®å¤ */
.row {
    margin-left: -15px;
    margin-right: -15px;
}
.row::after {
    content: "";
    display: table;
    clear: both;
}

/* å·¦ä¾§é…ç½®åŒºåŸŸ */
.sticky-config {
    position: -webkit-sticky;
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

/* å³ä¾§ä»»åŠ¡åŒºåŸŸ */
.sticky-tasks {
    position: -webkit-sticky;
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
}

/* ç´§å‡‘å‹è¡¨å•æ ·å¼ */
.form-group-sm {
    margin-bottom: 0.5rem;
}
.form-group-sm label.small {
    font-size: 0.8rem;
    font-weight: 500;
    color: #495057;
    display: block;
    white-space: nowrap;
}
.form-control-sm {
    font-size: 0.85rem;
    padding: 0.25rem 0.5rem;
    height: auto;
}

/* å¼ºåˆ¶å¤šåˆ—å¸ƒå±€ - é˜²æ­¢å“åº”å¼æ¢è¡Œ */
#collectForm .row {
    display: flex;
    flex-wrap: nowrap;
    margin-left: -5px;
    margin-right: -5px;
    gap: 0;
}
#collectForm .row > [class*="col-"] {
    padding-left: 5px;
    padding-right: 5px;
    flex-shrink: 0;
}
#collectForm .col-3 {
    width: 25%;
    flex: 0 0 25%;
}
#collectForm .col-4 {
    width: 33.333%;
    flex: 0 0 33.333%;
}
#collectForm .col-6 {
    width: 50%;
    flex: 0 0 50%;
}

/* å¡ç‰‡å›ºå®š */
.card {
    margin-bottom: 1rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
}
.card-header {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}
.card-body {
    padding: 1rem;
}

/* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
#taskList {
    clear: both;
}
.task-item {
    background: #f8f9fa;
    transition: all 0.3s;
    font-size: 0.85rem;
    clear: both;
    overflow: hidden;
}
.task-item:hover {
    background: #e9ecef;
}
.btn-xs {
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    line-height: 1.2;
}
.task-item .progress {
    clear: both;
    overflow: hidden;
}
.task-item .badge {
    display: inline-block;
    margin-right: 5px;
}

/* åˆ†ç±»é¢„è§ˆå¡ç‰‡æ ·å¼ */
.category-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
    clear: both;
    overflow: hidden;
}

.category-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.category-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s;
}

.category-card:hover::before {
    opacity: 1;
}

.category-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.category-card.active {
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
}

.category-card .category-name {
    font-size: 13px;
    font-weight: bold;
    color: white;
    margin-bottom: 5px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.category-card .category-count {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.9);
    background: rgba(0, 0, 0, 0.2);
    padding: 2px 6px;
    border-radius: 10px;
    display: inline-block;
}

/* è§†é¢‘é¢„è§ˆå¡ç‰‡æ ·å¼ */
.video-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    clear: both;
    overflow: hidden;
}

.video-card-preview {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s;
}

.video-card-preview:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.video-card-preview .video-thumb {
    width: 100%;
    height: 120px;
    object-fit: cover;
    background: #f0f0f0;
}

.video-card-preview .video-info {
    padding: 10px;
}

.video-card-preview .video-name {
    font-size: 13px;
    font-weight: 500;
    color: #333;
    margin-bottom: 5px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.video-card-preview .video-meta {
    font-size: 11px;
    color: #999;
}

.video-card-preview .video-meta span {
    margin-right: 8px;
}
</style>

<script>
let statusInterval = null;

// æµ‹è¯•é‡‡é›†URL
function testUrl() {
    const url = document.getElementById('collectUrl').value;
    const at = document.querySelector('select[name="at"]').value;
    
    if (!url) {
        alert('è¯·è¾“å…¥é‡‡é›†æ¥å£URL');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
    btn.disabled = true;
    
    fetch('{{ url_for("admin.maccms_collect_test") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({url: url, at: at})
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        
        if (data.success) {
            alert(`æ¥å£æµ‹è¯•æˆåŠŸï¼\n\næ€»æ•°æ®: ${data.info.total}\næ€»é¡µæ•°: ${data.info.pagecount}\næ¯é¡µ: ${data.info.limit}\nåˆ†ç±»æ•°: ${data.info.categories.length}\nç¤ºä¾‹æ•°æ®: ${data.info.sample_count} æ¡`);
        } else {
            alert('æµ‹è¯•å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('æµ‹è¯•å¤±è´¥: ' + error);
    });
}

// è·å–åˆ†ç±»åˆ—è¡¨
function loadCategories() {
    const url = document.getElementById('collectUrl').value;
    const at = document.querySelector('select[name="at"]').value;
    
    if (!url) {
        alert('è¯·è¾“å…¥é‡‡é›†æ¥å£URL');
        return;
    }
    
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...';
    btn.disabled = true;
    
    fetch('{{ url_for("admin.maccms_get_categories") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({url: url, at: at})
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        
        if (data.success) {
            // æ˜¾ç¤ºåˆ†ç±»å¡ç‰‡ï¼ˆå¸¦é€‰æ‹©åŠŸèƒ½ï¼‰
            displayCategoryCards(data.categories);
            // ç›´æ¥ä½¿ç”¨è¿”å›çš„è§†é¢‘åˆ—è¡¨æ˜¾ç¤ºé¢„è§ˆ
            if (data.videos && data.videos.length > 0) {
                displayVideoCards(data.videos);
            }
        } else {
            alert('è·å–åˆ†ç±»å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('è·å–åˆ†ç±»å¤±è´¥: ' + error);
    });
}

// æ˜¾ç¤ºåˆ†ç±»å¡ç‰‡ï¼ˆå¸¦é€‰æ‹©åŠŸèƒ½ï¼‰
function displayCategoryCards(categories) {
    const cardsContainer = document.getElementById('categoryCards');
    const previewSection = document.getElementById('categoryPreview');
    
    if (!categories || categories.length === 0) {
        previewSection.style.display = 'none';
        return;
    }
    
    previewSection.style.display = 'block';
    cardsContainer.innerHTML = '';
    
    categories.forEach(cat => {
        const card = document.createElement('div');
        card.className = 'category-card';
        card.dataset.typeId = cat.type_id;
        card.innerHTML = `
            <div class="category-name">${cat.type_name}</div>
            <div class="category-count">ID: ${cat.type_id}</div>
        `;
        
        // ç‚¹å‡»å¡ç‰‡é€‰æ‹©åˆ†ç±»
        card.onclick = function() {
            // æ›´æ–°è¡¨å•ä¸­çš„åˆ†ç±»ID
            document.querySelector('input[name="type_id"]').value = cat.type_id;
            
            // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
            cardsContainer.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
        };
        
        cardsContainer.appendChild(card);
    });
}

// æ˜¾ç¤ºè§†é¢‘å¡ç‰‡
function displayVideoCards(videos) {
    const container = document.getElementById('videoCards');
    
    if (videos.length === 0) {
        container.innerHTML = '<div class="text-center w-100 text-muted">è¯¥åˆ†ç±»æš‚æ— è§†é¢‘</div>';
        return;
    }
    
    // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆåŒºåŸŸ
    document.getElementById('videoPreview').style.display = 'block';
    
    container.innerHTML = '';
    videos.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card-preview';
        
        const imgUrl = video.vod_pic || '';
        const videoName = video.vod_name || 'æœªçŸ¥';
        const videoRemarks = video.vod_remarks || '';
        const videoYear = video.vod_year || '';
        const typeName = video.type_name || 'æœªåˆ†ç±»';
        
        card.innerHTML = `
            <img src="${imgUrl}" alt="${videoName}" class="video-thumb" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'120\\'%3E%3Crect fill=\\'%23f0f0f0\\' width=\\'200\\' height=\\'120\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23999\\' font-size=\\'14\\'%3Eæš‚æ— å›¾ç‰‡%3C/text%3E%3C/svg%3E'">
            <div class="video-info">
                <div class="video-name" title="${videoName}">${videoName}</div>
                <div class="video-meta">
                    <span>ğŸ“‚ ${typeName}</span>
                    ${videoYear ? `<span>ğŸ“… ${videoYear}</span>` : ''}
                    ${videoRemarks ? `<span>ğŸ“º ${videoRemarks}</span>` : ''}
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// æäº¤é‡‡é›†è¡¨å•
document.getElementById('collectForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const btn = this.querySelector('button[type="submit"]');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¯åŠ¨ä¸­...';
    btn.disabled = true;
    
    fetch('{{ url_for("admin.maccms_collect_start") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        
        if (data.success) {
            alert(data.message);
            // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°ä»»åŠ¡
            location.reload();
        } else {
            alert('å¯åŠ¨å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('å¯åŠ¨å¤±è´¥: ' + error);
    });
});

// åœæ­¢ä»»åŠ¡
function stopTask(taskId) {
    if (!confirm('ç¡®å®šè¦åœæ­¢ä»»åŠ¡ #' + taskId + ' å—ï¼Ÿ')) {
        return;
    }
    
    fetch(`{{ url_for("admin.maccms_collect_stop", task_id=0) }}`.replace('/0', '/' + taskId), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            updateTaskStatus(taskId);
        } else {
            alert('åœæ­¢å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('åœæ­¢å¤±è´¥: ' + error);
    });
}

// æ¸…ç†å·²å®Œæˆä»»åŠ¡
function cleanupTasks() {
    fetch('{{ url_for("admin.maccms_collect_cleanup") }}', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('æ¸…ç†å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        alert('æ¸…ç†å¤±è´¥: ' + error);
    });
}

// æ›´æ–°ä»»åŠ¡çŠ¶æ€
function updateTaskStatus(taskId) {
    fetch(`{{ url_for("admin.maccms_collect_status", task_id=0) }}`.replace('/0', '/' + taskId))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const status = data.status;
            const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskItem) {
                // æ›´æ–°è¿›åº¦æ¡å’Œç»Ÿè®¡
                const total = status.success_count + status.skip_count + status.failed_count;
                const successPct = total > 0 ? (status.success_count / total * 100) : 0;
                const skipPct = total > 0 ? (status.skip_count / total * 100) : 0;
                const failedPct = total > 0 ? (status.failed_count / total * 100) : 0;
                
                taskItem.querySelector('.progress').innerHTML = `
                    <div class="progress-bar bg-success" style="width: ${successPct}%">æˆåŠŸ: ${status.success_count}</div>
                    <div class="progress-bar bg-warning" style="width: ${skipPct}%">è·³è¿‡: ${status.skip_count}</div>
                    <div class="progress-bar bg-danger" style="width: ${failedPct}%">å¤±è´¥: ${status.failed_count}</div>
                `;
                
                taskItem.querySelector('small').textContent = `è¿ç»­é‡å¤: ${status.consecutive_duplicates} / 20`;
                
                // æ›´æ–°çŠ¶æ€æ ‡ç­¾
                if (!status.is_running) {
                    const badge = taskItem.querySelector('.badge');
                    badge.className = 'badge badge-secondary';
                    badge.textContent = 'å·²å®Œæˆ';
                    const stopBtn = taskItem.querySelector('.btn-danger');
                    if (stopBtn) stopBtn.remove();
                }
            }
        }
    });
}

// è‡ªåŠ¨åˆ·æ–°æ‰€æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡çŠ¶æ€
function startAutoRefresh() {
    statusInterval = setInterval(() => {
        const runningTasks = document.querySelectorAll('.task-item .badge-primary');
        runningTasks.forEach(badge => {
            const taskItem = badge.closest('.task-item');
            const taskId = taskItem.dataset.taskId;
            updateTaskStatus(taskId);
        });
    }, 3000); // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
}

// é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelectorAll('.task-item .badge-primary').length > 0) {
        startAutoRefresh();
    }
});

// é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
window.addEventListener('beforeunload', function() {
    if (statusInterval) {
        clearInterval(statusInterval);
    }
});
</script>
{% endblock %}
