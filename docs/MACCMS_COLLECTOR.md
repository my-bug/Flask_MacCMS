# MacCMS10 通用采集器使用文档

## 功能特点

本采集器完全兼容 MacCMS10 标准采集接口,支持市面上所有使用 MacCMS10 API 标准的资源站。

### 核心特性

1. 完全兼容 - 支持 MacCMS10 标准 JSON 和 XML 两种数据格式
2. 多线程采集 - 支持多线程并发采集,提高采集效率(默认3线程)
3. 智能去重 - 连续20个重复视频自动停止采集
4. 灵活配置 - 支持分类、搜索、时间筛选等多种采集参数
5. URL清理 - 自动清理播放地址,只保留纯URL
6. 实时监控 - Web界面实时显示采集进度和状态
7. 任务管理 - 支持多任务并行、手动停止、任务清理

## 接口格式

### 标准 MacCMS10 API 格式

```
http://域名/api.php/provide/vod/
```

常见的接口格式:
- `http://cj.example.com/api.php/provide/vod/` - 标准格式
- `http://api.example.com/api.php/provide/vod/at/xml/` - 指定XML格式
- `http://example.com/inc/api.php` - 简化格式

## 支持的参数

### 操作类型 (ac)

- `list` - 获取分类和简要列表(不含播放数据)
- `detail` - 获取详细数据(含完整播放信息)
- `videolist` - 同detail,获取详细数据

推荐使用: `videolist` 或 `detail`,包含完整播放数据

### 返回格式 (at)

- `json` - JSON格式(推荐,解析更快)
- `xml` - XML格式(兼容老版本)

### 筛选参数

- `t` - 分类ID,如 `1`(电影)、`2`(电视剧)
- `pg` - 页码,从 `1` 开始
- `ids` - 视频ID列表,如 `123,456,789`
- `wd` - 搜索关键词,如 `复仇者联盟`
- `h` - 最近N小时内的数据,如 `24`(最近24小时)

## 使用步骤

### 1. 进入采集页面

后台管理 → MacCMS采集

### 2. 配置采集参数

#### 必填项：
- 采集接口URL: 资源站提供的API地址

#### 可选项：
- 操作类型: 选择 `videolist` 获取完整数据
- 返回格式: 推荐使用 `json`
- 分类ID: 指定采集某个分类，留空采集全部
- 起始页: 从第几页开始采集（默认1）
- 结束页: 采集到第几页，留空采集全部
- 并发线程: 同时采集的线程数（1-10，默认3）
- 更新已存在: 是否更新数据库中已存在的视频

### 3. 测试接口

点击"测试"按钮验证接口是否可用，会显示：
- 总数据量
- 总页数
- 每页数据量
- 可用分类数量

### 4. 获取分类(可选)

点击"获取分类"按钮,系统会列出该资源站的所有分类,点击分类按钮可自动填入分类ID。

### 5. 开始采集

点击"开始采集"按钮,系统会:
1. 创建采集任务
2. 显示实时进度
3. 自动处理重复视频
4. 达到阈值自动停止

### 6. 监控进度

右侧任务列表实时显示:
- 成功数量(绿色)
- 跳过数量(黄色)
- 失败数量(红色)
- 连续重复计数

## 采集策略

### 智能分页

1. 首页单独采集 - 先采集第一页获取总页数
2. 多线程并发 - 剩余页面使用多线程并发采集
3. 顺序保证 - 每个线程独立处理页面,互不干扰

### 重复处理

- 检测机制: 根据 `vod_name`(视频名称)判断重复
- 更新策略: 可选择更新或跳过已存在视频
- 自动停止: 连续20个重复视频自动停止采集(防止浪费资源)

### URL清理

自动清理播放地址格式:
```
原始: 第1集$http://xxx.com/1.m3u8#第2集$http://xxx.com/2.m3u8
清理后: http://xxx.com/1.m3u8#http://xxx.com/2.m3u8
```

## 常见场景

### 场景1: 全量采集

```
URL: http://cj.example.com/api.php/provide/vod/
操作类型: videolist
返回格式: json
起始页: 1
结束页: (留空)
```

### 场景2: 增量更新

```
URL: http://cj.example.com/api.php/provide/vod/
操作类型: videolist
返回格式: json
时间筛选: 24  (最近24小时)
更新已存在: ✓
```

### 场景3: 指定分类采集

```
URL: http://cj.example.com/api.php/provide/vod/
操作类型: videolist
返回格式: json
分类ID: 1  (电影)
起始页: 1
结束页: 10
```

### 场景4: 搜索采集

```
URL: http://cj.example.com/api.php/provide/vod/
操作类型: videolist
返回格式: json
搜索关键词: 漫威
```

### 场景5: 指定视频采集

```
URL: http://cj.example.com/api.php/provide/vod/
操作类型: detail
返回格式: json
视频ID列表: 123,456,789,1011
```

## 性能优化

### 并发设置

- 1-2线程: 适合网络不稳定或资源站限制较严格的情况
- 3-5线程: 推荐设置，平衡速度和稳定性
- 6-10线程: 适合网络良好且资源站无限制的情况

### 采集时机

- 夜间采集: 资源站负载低，采集更稳定
- 分批采集: 大量数据分多次采集，避免长时间运行
- 增量更新: 定期采集最近更新的数据（使用时间筛选）

## 故障排除

### 问题1: 接口测试失败

可能原因:
- URL格式不正确
- 资源站服务异常
- 网络连接问题

解决方案:
- 检查URL格式是否正确
- 在浏览器中访问API测试
- 检查防火墙和网络设置

### 问题2: 采集速度慢

可能原因:
- 并发线程数太少
- 网络延迟高
- 资源站响应慢

解决方案:
- 适当增加并发线程数（3-5）
- 选择网络较好的时段采集
- 更换响应更快的资源站

### 问题3: 大量跳过

可能原因:
- 视频已存在数据库
- 重复采集同一页面

解决方案:
- 正常现象，说明数据已是最新
- 使用时间筛选只采集新增数据
- 调整起始页码避免重复采集

### 问题4: 自动停止

可能原因:
- 连续20个重复视频
- 手动停止
- 程序异常

解决方案:
- 检查系统日志查看停止原因
- 正常情况，说明新数据已采集完成
- 调整采集参数重新启动

## 技术特点

### 数据格式兼容

- JSON格式: 直接解析，性能最优
- XML格式: 使用ElementTree解析，兼容性好
- 自动识别: 根据返回内容自动选择解析器

### 数据标准化

所有采集的数据统一转换为标准格式：
```python
{
    'vod_name': '视频名称',
    'vod_pic': '封面图片',
    'vod_actor': '演员',
    'vod_director': '导演',
    'vod_content': '简介',
    'vod_play_from': '播放来源',
    'vod_play_url': '播放地址',
    ...
}
```

### 线程安全

- 数据库锁: 确保多线程写入数据安全
- 计数器锁: 保护共享统计变量
- 上下文传递: Flask应用上下文正确传递到子线程

## 日志记录

系统会记录详细的采集日志：

- 开始日志: 记录采集参数和配置
- 页面日志: 每页采集完成后记录统计
- 错误日志: 记录采集过程中的异常
- 完成日志: 记录最终统计结果

查看日志：后台管理 → 系统日志 → 筛选"采集"类型

## 最佳实践

1. 首次采集: 先测试接口，获取分类，小范围测试（1-2页）
2. 批量采集: 确认无误后再进行大批量采集
3. 定期更新: 设置定时任务，每日增量采集新数据
4. 监控日志: 定期查看系统日志，及时发现问题
5. 数据备份: 大量采集前备份数据库
6. 分类绑定: 采集前规划好本地分类与远程分类的对应关系

## API接口示例

### 完整URL示例

```
# 获取所有视频（详情）
http://cj.example.com/api.php/provide/vod/?ac=videolist

# 获取第2页
http://cj.example.com/api.php/provide/vod/?ac=videolist&pg=2

# 获取电影分类
http://cj.example.com/api.php/provide/vod/?ac=videolist&t=1

# 搜索
http://cj.example.com/api.php/provide/vod/?ac=videolist&wd=战狼

# 最近24小时
http://cj.example.com/api.php/provide/vod/?ac=videolist&h=24

# XML格式
http://cj.example.com/api.php/provide/vod/?ac=videolist&at=xml

# 指定视频
http://cj.example.com/api.php/provide/vod/?ac=detail&ids=123,456
```

## 总结

MacCMS10通用采集器提供了完整的、高效的视频采集解决方案，支持市面上所有MacCMS10标准接口的资源站。通过灵活的参数配置和智能的采集策略，可以快速构建丰富的视频内容库。
